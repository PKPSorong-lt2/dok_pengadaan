<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daftar Paket - Sistem Pengadaan</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="app-layout">
    
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">üìã SIPBJ</div>
        <div class="sidebar-subtitle">Sistem Informasi Pengadaan<br>Barang & Jasa</div>
      </div>
      <nav class="sidebar-menu">
        <a href="../index.html" class="menu-item"><span class="menu-icon">üè†</span><span class="menu-text">Dashboard</span></a>
        <div class="menu-title">Pengadaan</div>
        <a href="projects.html" class="menu-item active"><span class="menu-icon">üìÅ</span><span class="menu-text">Daftar Paket</span></a>
        <a href="project-new.html" class="menu-item"><span class="menu-icon">‚ûï</span><span class="menu-text">Buat Paket Baru</span></a>
        <div class="menu-title">Dokumen</div>
        <a href="hps.html" class="menu-item"><span class="menu-icon">üìä</span><span class="menu-text">HPS</span></a>
        <a href="bapp.html" class="menu-item"><span class="menu-icon">üîç</span><span class="menu-text">BA Pemeriksaan</span></a>
        <a href="bast.html" class="menu-item"><span class="menu-icon">ü§ù</span><span class="menu-text">BAST</span></a>
        <a href="ba-bayar.html" class="menu-item"><span class="menu-icon">üí≥</span><span class="menu-text">BA Pembayaran</span></a>
        <a href="kuitansi.html" class="menu-item"><span class="menu-icon">üßæ</span><span class="menu-text">Kuitansi</span></a>
        <div class="menu-title">Lainnya</div>
        <a href="settings.html" class="menu-item"><span class="menu-icon">‚öôÔ∏è</span><span class="menu-text">Pengaturan</span></a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      
      <div class="breadcrumb">
        <a href="../index.html">Dashboard</a> / <span>Daftar Paket</span>
      </div>

      <div class="page-header">
        <div>
          <h1 class="page-title">üìÅ Daftar Paket Pengadaan</h1>
          <p class="page-subtitle">Kelola semua paket pengadaan barang dan jasa</p>
        </div>
        <a href="project-new.html" class="btn btn-primary">‚ûï Buat Paket Baru</a>
      </div>

      <!-- Filter -->
      <div class="card">
        <div class="card-body" style="padding:12px 20px;">
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
            <div style="flex:1;min-width:200px;">
              <input type="text" id="searchInput" class="form-control" placeholder="üîç Cari nama paket..." onkeyup="filterTable()">
            </div>
            <div>
              <select id="filterStatus" class="form-control" onchange="filterTable()">
                <option value="">Semua Status</option>
                <option value="Draft">Draft</option>
                <option value="Proses">Proses</option>
                <option value="Selesai">Selesai</option>
              </select>
            </div>
            <div>
              <select id="filterJenis" class="form-control" onchange="filterTable()">
                <option value="">Semua Jenis</option>
                <option value="Pengadaan Langsung">Pengadaan Langsung</option>
                <option value="Penunjukan Langsung">Penunjukan Langsung</option>
                <option value="Tender">Tender</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="card">
        <div class="card-body">
          
          <!-- Status -->
          <div id="statusBox" class="alert alert-info">
            <span id="statusText">Memuat data...</span>
          </div>
          
          <!-- Table -->
          <div id="tableContainer" style="display:none;">
            <table>
              <thead>
                <tr>
                  <th style="width:50px;">No</th>
                  <th>Nama Paket</th>
                  <th>Jenis</th>
                  <th>Unit</th>
                  <th class="text-right">Nilai</th>
                  <th class="text-center">Status</th>
                  <th class="text-center" style="width:120px;">Aksi</th>
                </tr>
              </thead>
              <tbody id="projectsTable"></tbody>
            </table>
          </div>
          
        </div>
      </div>

    </main>
  </div>

  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/utils.js"></script>
  <script>
    var allProjects = [];

    // Load saat halaman ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Page loaded');
      console.log('API URL:', CONFIG.API_URL);
      console.log('API Configured:', CONFIG.isConfigured());
      
      loadProjects();
    });

    function setStatus(msg, type) {
      var box = document.getElementById('statusBox');
      var text = document.getElementById('statusText');
      text.innerHTML = msg;
      box.className = 'alert alert-' + (type || 'info');
      box.style.display = 'block';
    }

    function loadProjects() {
      console.log('=== loadProjects START ===');
      setStatus('Memuat data dari server...', 'info');
      
      // Check config - gunakan CONFIG.isConfigured() langsung
      if (!CONFIG.isConfigured()) {
        setStatus('‚ö†Ô∏è API belum dikonfigurasi. <a href="settings.html">Buka Pengaturan</a> untuk setup.', 'warning');
        return;
      }
      
      var url = CONFIG.API_URL + '?action=getProjects';
      console.log('Fetching:', url);
      
      fetch(url, { method: 'GET', redirect: 'follow' })
        .then(function(response) {
          console.log('Response status:', response.status);
          return response.text();
        })
        .then(function(text) {
          console.log('Response text:', text);
          
          try {
            var result = JSON.parse(text);
            console.log('Parsed result:', result);
            
            if (!result.success) {
              setStatus('‚ùå Error: ' + (result.error || 'Unknown'), 'error');
              return;
            }
            
            var data = result.data;
            if (!data || !Array.isArray(data)) {
              setStatus('‚ùå Data tidak valid', 'error');
              return;
            }
            
            allProjects = data;
            console.log('Projects count:', allProjects.length);
            
            if (allProjects.length === 0) {
              setStatus('üì≠ Belum ada paket pengadaan. Klik "Buat Paket Baru" untuk memulai.', 'info');
              return;
            }
            
            // Render table
            renderTable(allProjects);
            
            // Hide status, show table
            document.getElementById('statusBox').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';
            
            console.log('=== loadProjects SUCCESS ===');
            
          } catch (e) {
            console.log('Parse error:', e);
            setStatus('‚ùå Gagal parse response: ' + e.message, 'error');
          }
        })
        .catch(function(err) {
          console.log('Fetch error:', err);
          setStatus('‚ùå Network error: ' + err.message, 'error');
        });
    }

    function renderTable(projects) {
      console.log('renderTable called with', projects.length, 'projects');
      
      var tbody = document.getElementById('projectsTable');
      var html = '';
      
      for (var i = 0; i < projects.length; i++) {
        var p = projects[i];
        
        var nama = p.namaProject || '-';
        var jenis = p.jenisPengadaan || 'Langsung';
        var unit = p.unit || '-';
        var nilai = p.nilaiKontrak || 0;
        var status = p.status || 'Draft';
        var id = p.projectId || '';
        
        var statusClass = 'badge-secondary';
        if (status === 'Selesai') statusClass = 'badge-success';
        if (status === 'Proses') statusClass = 'badge-warning';
        
        html += '<tr data-nama="' + nama.toLowerCase() + '" data-status="' + status + '" data-jenis="' + jenis + '">';
        html += '<td>' + (i + 1) + '</td>';
        html += '<td><a href="project-detail.html?id=' + id + '" style="font-weight:500;">' + escapeHtml(nama) + '</a>';
        html += '</td>';
        html += '<td><span class="badge badge-info" style="font-size:11px;">' + escapeHtml(jenis) + '</span></td>';
        html += '<td>' + escapeHtml(unit) + '</td>';
        html += '<td class="text-right">' + formatRupiah(nilai) + '</td>';
        html += '<td class="text-center"><span class="badge ' + statusClass + '">' + escapeHtml(status) + '</span></td>';
        html += '<td class="text-center">';
        html += '<a href="project-detail.html?id=' + id + '" class="btn btn-primary btn-sm">Detail</a> ';
        html += '<button class="btn btn-danger btn-sm" onclick="hapusPaket(\'' + id + '\')">üóëÔ∏è</button>';
        html += '</td>';
        html += '</tr>';
      }
      
      tbody.innerHTML = html;
      console.log('Table rendered');
    }

    function filterTable() {
      var search = document.getElementById('searchInput').value.toLowerCase();
      var status = document.getElementById('filterStatus').value;
      var jenis = document.getElementById('filterJenis').value;
      
      var rows = document.querySelectorAll('#projectsTable tr');
      
      rows.forEach(function(row) {
        var nama = row.getAttribute('data-nama') || '';
        var rowStatus = row.getAttribute('data-status') || '';
        var rowJenis = row.getAttribute('data-jenis') || '';
        
        var show = true;
        if (search && nama.indexOf(search) === -1) show = false;
        if (status && rowStatus !== status) show = false;
        if (jenis && rowJenis.indexOf(jenis) === -1) show = false;
        
        row.style.display = show ? '' : 'none';
      });
    }

    function hapusPaket(projectId) {
      if (!confirm('Hapus paket ini?')) return;
      
      setStatus('Menghapus...', 'warning');
      
      fetch(CONFIG.API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'deleteProject', data: { projectId: projectId } })
      })
      .then(function(r) { return r.json(); })
      .then(function(result) {
        if (result.success) {
          loadProjects();
        } else {
          setStatus('‚ùå Gagal hapus: ' + result.error, 'error');
        }
      })
      .catch(function(err) {
        setStatus('‚ùå Error: ' + err.message, 'error');
      });
    }
    
    // Simple helpers (tidak bergantung pada Utils)
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
    
    function formatRupiah(num) {
      if (!num || isNaN(num)) return 'Rp 0';
      return 'Rp ' + Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }
  </script>
</body>
</html>
