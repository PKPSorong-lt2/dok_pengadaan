<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HPS - Sistem Pengadaan</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .survey-card { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
    .survey-card h5 { margin: 0 0 10px 0; font-size: 13px; color: #1976d2; }
    .link-input { font-size: 12px; }
    .calc-box { background: #e8f5e9; padding: 15px; border-radius: 8px; }
    .calc-row { display: flex; justify-content: space-between; padding: 5px 0; }
    .calc-total { font-size: 18px; color: #2e7d32; border-top: 2px solid #a5d6a7; padding-top: 10px; margin-top: 10px; }
    .data-dukung { background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px; }
    .data-dukung h5 { margin: 0 0 10px 0; font-size: 13px; color: #e65100; }
    .item-row { cursor: pointer; }
    .item-row:hover { background: #e3f2fd; }
    .item-pending { background: #fff8e1; }
    .item-done { background: #e8f5e9; }
    .pagu-box { background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px; }
    .pagu-exceeded { background: #ffebee; border: 2px solid #f44336; }
  </style>
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">üìã SIPBJ</div>
        <div class="sidebar-subtitle">Sistem Informasi Pengadaan<br>Barang & Jasa</div>
      </div>
      <nav class="sidebar-menu">
        <a href="../index.html" class="menu-item"><span class="menu-icon">üè†</span><span class="menu-text">Dashboard</span></a>
        <div class="menu-title">Pengadaan</div>
        <a href="projects.html" class="menu-item"><span class="menu-icon">üìÅ</span><span class="menu-text">Daftar Paket</span></a>
        <a href="project-new.html" class="menu-item"><span class="menu-icon">‚ûï</span><span class="menu-text">Buat Paket Baru</span></a>
        <div class="menu-title">Dokumen</div>
        <a href="hps.html" class="menu-item active"><span class="menu-icon">üìä</span><span class="menu-text">HPS</span></a>
        <a href="bapp.html" class="menu-item"><span class="menu-icon">üîç</span><span class="menu-text">BA Pemeriksaan</span></a>
        <a href="bast.html" class="menu-item"><span class="menu-icon">ü§ù</span><span class="menu-text">BAST</span></a>
        <a href="ba-bayar.html" class="menu-item"><span class="menu-icon">üí≥</span><span class="menu-text">BA Pembayaran</span></a>
        <a href="kuitansi.html" class="menu-item"><span class="menu-icon">üßæ</span><span class="menu-text">Kuitansi</span></a>
        <div class="menu-title">Lainnya</div>
        <a href="settings.html" class="menu-item"><span class="menu-icon">‚öôÔ∏è</span><span class="menu-text">Pengaturan</span></a>
      </nav>
    </aside>
    
    <main class="main-content">
      <div class="breadcrumb"><a href="../index.html">Dashboard</a> / <span>HPS</span></div>
      
      <div class="page-header">
        <div>
          <h1 class="page-title">üìä Harga Perkiraan Sendiri (HPS)</h1>
          <p class="page-subtitle">Lengkapi survey 3 pembanding harga untuk setiap item</p>
        </div>
      </div>
      
      <!-- Status -->
      <div id="statusBox" class="alert alert-info" style="display:none;"></div>
      
      <!-- Pilih Paket -->
      <div class="card">
        <div class="card-header"><h2 class="card-title">Pilih Paket Pengadaan</h2></div>
        <div class="card-body">
          <div class="form-group">
            <label class="form-label">Paket Pengadaan <span class="required">*</span></label>
            <select id="selectProject" class="form-control" onchange="onProjectChange()">
              <option value="">-- Pilih Paket --</option>
            </select>
          </div>
          
          <div id="projectInfo" style="display:none;background:#f8f9fa;padding:15px;border-radius:8px;margin-top:15px;">
            <div style="display:flex;flex-wrap:wrap;gap:20px;">
              <div><strong>Jenis:</strong> <span id="infoJenis">-</span></div>
              <div><strong>Unit:</strong> <span id="infoUnit">-</span></div>
              <div><strong>Pagu:</strong> <span id="infoPagu" style="color:#e65100;font-weight:600;">-</span></div>
            </div>
          </div>
          
          <div class="form-group mt-3">
            <label class="form-label">Metode Perhitungan HPS</label>
            <div style="display:flex;gap:20px;">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                <input type="radio" name="metodeHps" value="rata-rata" checked onchange="recalculateAll()"> Rata-rata 3 Pembanding
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                <input type="radio" name="metodeHps" value="terendah" onchange="recalculateAll()"> Harga Terendah
              </label>
            </div>
            <p class="form-hint">Metode rata-rata: HPS = (H1+H2+H3)/3 √ó Volume</p>
          </div>
        </div>
      </div>
      
      <!-- Daftar Item untuk Survey -->
      <div id="itemsSection" class="card" style="display:none;">
        <div class="card-header">
          <h2 class="card-title">üì¶ Survey Harga Item</h2>
          <span id="itemProgress" class="badge badge-info">0/0</span>
        </div>
        <div class="card-body">
          
          <div id="noItemsAlert" class="alert alert-warning" style="display:none;">
            ‚ö†Ô∏è Belum ada item. <a href="#" id="linkToDetail">Tambahkan item di Detail Paket</a>
          </div>
          
          <div id="itemsTableContainer" style="display:none;">
            <p class="form-hint mb-2">Klik item untuk mengisi survey harga 3 pembanding</p>
            
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>No</th>
                    <th>Nama Barang/Jasa</th>
                    <th>Spek</th>
                    <th class="text-right">Vol</th>
                    <th>Sat</th>
                    <th class="text-right">H1</th>
                    <th class="text-right">H2</th>
                    <th class="text-right">H3</th>
                    <th class="text-right">Harga HPS</th>
                    <th class="text-right">Jumlah</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="itemsTable"></tbody>
                <tfoot>
                  <tr style="background:#e3f2fd;font-weight:600;">
                    <td colspan="9" class="text-right">TOTAL HPS:</td>
                    <td class="text-right" id="grandTotal">Rp 0</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
            
            <!-- Pagu Check -->
            <div id="paguBox" class="pagu-box" style="display:none;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <strong>Pagu Anggaran:</strong> <span id="paguAmount">Rp 0</span>
                </div>
                <div>
                  <strong>Sisa:</strong> <span id="sisaPagu">Rp 0</span>
                </div>
              </div>
              <div id="paguWarning" class="alert alert-error mt-2" style="display:none;">
                ‚ö†Ô∏è <strong>MELEBIHI PAGU!</strong> Perlu penyesuaian volume atau cari harga lebih murah.
              </div>
            </div>
          </div>
          
        </div>
      </div>
      
      <!-- Preview & Print -->
      <div id="actionsSection" class="card" style="display:none;">
        <div class="card-header"><h2 class="card-title">üìÑ Cetak Dokumen HPS</h2></div>
        <div class="card-body">
          <button class="btn btn-primary" onclick="previewHPS()">üëÅÔ∏è Preview & Cetak</button>
          <button class="btn btn-secondary" onclick="goToDetail()">‚Üê Kembali ke Detail Paket</button>
        </div>
      </div>

    </main>
  </div>

  <!-- Modal Survey Harga -->
  <div id="surveyModal" class="modal">
    <div class="modal-content" style="max-width:750px;">
      <div class="modal-header">
        <h3 class="modal-title">Survey Harga: <span id="modalItemName">-</span></h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
        <input type="hidden" id="modalItemId">
        
        <!-- Item Info (readonly) -->
        <div style="background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:15px;">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Nama Barang</label>
              <div id="modalNama" class="form-control" style="background:#fff;">-</div>
            </div>
            <div class="form-group" style="flex:0.5;">
              <label class="form-label">Volume</label>
              <div id="modalVolume" class="form-control" style="background:#fff;">-</div>
            </div>
            <div class="form-group" style="flex:0.5;">
              <label class="form-label">Satuan</label>
              <div id="modalSatuan" class="form-control" style="background:#fff;">-</div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Spesifikasi</label>
            <div id="modalSpek" class="form-control" style="background:#fff;min-height:40px;">-</div>
          </div>
        </div>
        
        <!-- Survey 3 Pembanding -->
        <h5 style="margin:0 0 10px 0;font-size:14px;color:#1976d2;">üìä Survey 3 Pembanding Harga (per satuan)</h5>
        
        <!-- Pembanding 1 -->
        <div class="survey-card">
          <h5>üè™ Pembanding 1</h5>
          <div class="form-row">
            <div class="form-group" style="flex:2;">
              <label class="form-label">Nama Toko/Vendor <span class="required">*</span></label>
              <input type="text" id="surveyVendor1" class="form-control" placeholder="Tokopedia - Toko ABC">
            </div>
            <div class="form-group" style="flex:1;">
              <label class="form-label">Harga Satuan <span class="required">*</span></label>
              <input type="number" id="surveyHarga1" class="form-control" min="0" placeholder="50000" onchange="calcSurvey()">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Link E-Commerce / Sumber</label>
            <input type="url" id="surveyLink1" class="form-control link-input" placeholder="https://tokopedia.com/...">
          </div>
        </div>
        
        <!-- Pembanding 2 -->
        <div class="survey-card">
          <h5>üè™ Pembanding 2</h5>
          <div class="form-row">
            <div class="form-group" style="flex:2;">
              <label class="form-label">Nama Toko/Vendor <span class="required">*</span></label>
              <input type="text" id="surveyVendor2" class="form-control" placeholder="Shopee - Toko XYZ">
            </div>
            <div class="form-group" style="flex:1;">
              <label class="form-label">Harga Satuan <span class="required">*</span></label>
              <input type="number" id="surveyHarga2" class="form-control" min="0" placeholder="52000" onchange="calcSurvey()">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Link E-Commerce / Sumber</label>
            <input type="url" id="surveyLink2" class="form-control link-input" placeholder="https://shopee.co.id/...">
          </div>
        </div>
        
        <!-- Pembanding 3 -->
        <div class="survey-card">
          <h5>üè™ Pembanding 3</h5>
          <div class="form-row">
            <div class="form-group" style="flex:2;">
              <label class="form-label">Nama Toko/Vendor <span class="required">*</span></label>
              <input type="text" id="surveyVendor3" class="form-control" placeholder="Bukalapak - Toko 123">
            </div>
            <div class="form-group" style="flex:1;">
              <label class="form-label">Harga Satuan <span class="required">*</span></label>
              <input type="number" id="surveyHarga3" class="form-control" min="0" placeholder="48000" onchange="calcSurvey()">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Link E-Commerce / Sumber</label>
            <input type="url" id="surveyLink3" class="form-control link-input" placeholder="https://bukalapak.com/...">
          </div>
        </div>
        
        <!-- Data Dukung -->
        <div class="data-dukung">
          <h5>üìé Data Dukung (Opsional)</h5>
          <p class="form-hint">Link file pendukung: kontrak sebelumnya, screenshot, katalog</p>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Link 1</label>
              <input type="url" id="surveyDukung1" class="form-control link-input" placeholder="https://drive.google.com/...">
              <input type="text" id="surveyDukungKet1" class="form-control mt-1 link-input" placeholder="Keterangan">
            </div>
            <div class="form-group">
              <label class="form-label">Link 2</label>
              <input type="url" id="surveyDukung2" class="form-control link-input" placeholder="https://drive.google.com/...">
              <input type="text" id="surveyDukungKet2" class="form-control mt-1 link-input" placeholder="Keterangan">
            </div>
          </div>
        </div>
        
        <!-- Kalkulasi -->
        <div class="calc-box mt-3">
          <div class="calc-row">
            <span>Harga Terendah:</span>
            <strong id="calcTerendah">Rp 0</strong>
          </div>
          <div class="calc-row">
            <span>Harga Rata-rata:</span>
            <strong id="calcRata">Rp 0</strong>
          </div>
          <div class="calc-row">
            <span>Metode Dipilih:</span>
            <strong id="calcMetode">Rata-rata</strong>
          </div>
          <div class="calc-row">
            <span>Harga Satuan HPS:</span>
            <strong id="calcHargaHps">Rp 0</strong>
          </div>
          <div class="calc-row calc-total">
            <span>TOTAL HPS ITEM (√ó <span id="calcVol">0</span>):</span>
            <strong id="calcTotal">Rp 0</strong>
          </div>
        </div>
        
        <div id="modalAlert" class="alert hidden mt-2"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Batal</button>
        <button class="btn btn-primary" id="saveBtn" onclick="saveSurvey()">üíæ Simpan Survey</button>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div id="previewModal" class="modal">
    <div class="modal-content" style="max-width:900px;">
      <div class="modal-header">
        <h3 class="modal-title">Preview Dokumen HPS</h3>
        <button class="modal-close" onclick="closePreview()">&times;</button>
      </div>
      <div class="modal-body" id="previewContent" style="max-height:70vh;overflow-y:auto;"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePreview()">Tutup</button>
        <button class="btn btn-primary" onclick="printHPS()">üñ®Ô∏è Cetak</button>
      </div>
    </div>
  </div>

  <script src="../js/config.js"></script>
  <script>
    var currentProject = null;
    var currentItems = [];
    var currentItemId = null;
    var paguAnggaran = 0;

    document.addEventListener('DOMContentLoaded', function() {
      loadProjects();
    });

    function setStatus(msg, type) {
      var box = document.getElementById('statusBox');
      box.innerHTML = msg;
      box.className = 'alert alert-' + (type || 'info');
      box.style.display = 'block';
    }

    function hideStatus() {
      document.getElementById('statusBox').style.display = 'none';
    }

    // ========== Load Projects ==========
    function loadProjects() {
      var url = CONFIG.API_URL + '?action=getProjects';
      
      fetch(url)
        .then(function(r) { return r.json(); })
        .then(function(result) {
          if (result.success && result.data) {
            var select = document.getElementById('selectProject');
            result.data.forEach(function(p) {
              var opt = document.createElement('option');
              opt.value = p.projectId;
              opt.textContent = p.namaProject + ' (' + (p.jenisPengadaan || 'Langsung') + ')';
              select.appendChild(opt);
            });
            
            // Check URL param
            var pid = getUrlParam('id') || getUrlParam('projectId');
            if (pid) {
              select.value = pid;
              onProjectChange();
            }
          }
        })
        .catch(function(err) {
          setStatus('Gagal load projects: ' + err.message, 'error');
        });
    }

    function onProjectChange() {
      var projectId = document.getElementById('selectProject').value;
      
      if (!projectId) {
        document.getElementById('projectInfo').style.display = 'none';
        document.getElementById('itemsSection').style.display = 'none';
        document.getElementById('actionsSection').style.display = 'none';
        return;
      }
      
      loadProjectDetail(projectId);
    }

    function loadProjectDetail(projectId) {
      setStatus('Memuat data...', 'info');
      
      var url = CONFIG.API_URL + '?action=getProjectDetail&projectId=' + encodeURIComponent(projectId);
      
      fetch(url)
        .then(function(r) { return r.json(); })
        .then(function(result) {
          hideStatus();
          
          if (!result.success) {
            setStatus('Error: ' + result.error, 'error');
            return;
          }
          
          currentProject = result.data;
          currentItems = currentProject.items || [];
          paguAnggaran = currentProject.paguAnggaran || currentProject.nilaiKontrak || 0;
          
          // Show info
          document.getElementById('infoJenis').textContent = currentProject.jenisPengadaan || '-';
          document.getElementById('infoUnit').textContent = currentProject.unit || '-';
          document.getElementById('infoPagu').textContent = formatRupiah(paguAnggaran);
          document.getElementById('projectInfo').style.display = 'block';
          
          // Update link to detail
          document.getElementById('linkToDetail').href = 'project-detail.html?id=' + projectId;
          
          // Render items
          renderItems();
          
          document.getElementById('itemsSection').style.display = 'block';
          document.getElementById('actionsSection').style.display = 'block';
        })
        .catch(function(err) {
          setStatus('Network error: ' + err.message, 'error');
        });
    }

    // ========== Render Items ==========
    function renderItems() {
      var tbody = document.getElementById('itemsTable');
      
      if (currentItems.length === 0) {
        document.getElementById('noItemsAlert').style.display = 'block';
        document.getElementById('itemsTableContainer').style.display = 'none';
        document.getElementById('itemProgress').textContent = '0/0';
        return;
      }
      
      document.getElementById('noItemsAlert').style.display = 'none';
      document.getElementById('itemsTableContainer').style.display = 'block';
      
      var html = '';
      var total = 0;
      var completed = 0;
      var metode = getMetode();
      
      for (var i = 0; i < currentItems.length; i++) {
        var item = currentItems[i];
        var hasHps = item.harga1 > 0 && item.harga2 > 0 && item.harga3 > 0;
        
        var hargaHps = 0;
        var jumlah = 0;
        
        if (hasHps) {
          completed++;
          hargaHps = metode === 'terendah' ? (item.hargaTerendah || 0) : (item.hargaRata || 0);
          jumlah = (item.volume || 0) * hargaHps;
          total += jumlah;
        }
        
        var rowClass = hasHps ? 'item-done' : 'item-pending';
        var statusBadge = hasHps 
          ? '<span class="badge badge-success">‚úì</span>'
          : '<span class="badge badge-warning">‚è≥</span>';
        
        html += '<tr class="item-row ' + rowClass + '" onclick="openSurvey(\'' + item.itemId + '\')">';
        html += '<td>' + (i + 1) + '</td>';
        html += '<td><strong>' + esc(item.namaBarang) + '</strong></td>';
        html += '<td><small>' + esc(item.spesifikasi || '-') + '</small></td>';
        html += '<td class="text-right">' + (item.volume || 0) + '</td>';
        html += '<td>' + esc(item.satuan) + '</td>';
        html += '<td class="text-right"><small>' + (hasHps ? formatRupiah(item.harga1) : '-') + '</small></td>';
        html += '<td class="text-right"><small>' + (hasHps ? formatRupiah(item.harga2) : '-') + '</small></td>';
        html += '<td class="text-right"><small>' + (hasHps ? formatRupiah(item.harga3) : '-') + '</small></td>';
        html += '<td class="text-right">' + (hasHps ? formatRupiah(hargaHps) : '-') + '</td>';
        html += '<td class="text-right"><strong>' + (hasHps ? formatRupiah(jumlah) : '-') + '</strong></td>';
        html += '<td class="text-center">' + statusBadge + '</td>';
        html += '</tr>';
      }
      
      tbody.innerHTML = html;
      document.getElementById('grandTotal').textContent = formatRupiah(total);
      document.getElementById('itemProgress').textContent = completed + '/' + currentItems.length;
      
      // Pagu check
      if (paguAnggaran > 0) {
        document.getElementById('paguBox').style.display = 'block';
        document.getElementById('paguAmount').textContent = formatRupiah(paguAnggaran);
        
        var sisa = paguAnggaran - total;
        document.getElementById('sisaPagu').textContent = formatRupiah(sisa);
        document.getElementById('sisaPagu').style.color = sisa >= 0 ? '#2e7d32' : '#d32f2f';
        
        if (sisa < 0) {
          document.getElementById('paguBox').classList.add('pagu-exceeded');
          document.getElementById('paguWarning').style.display = 'block';
        } else {
          document.getElementById('paguBox').classList.remove('pagu-exceeded');
          document.getElementById('paguWarning').style.display = 'none';
        }
      } else {
        document.getElementById('paguBox').style.display = 'none';
      }
    }

    function recalculateAll() {
      renderItems();
    }

    function getMetode() {
      return document.querySelector('input[name="metodeHps"]:checked').value;
    }

    // ========== Survey Modal ==========
    function openSurvey(itemId) {
      var item = currentItems.find(function(x) { return x.itemId === itemId; });
      if (!item) return;
      
      currentItemId = itemId;
      
      // Populate info (readonly)
      document.getElementById('modalItemId').value = itemId;
      document.getElementById('modalItemName').textContent = item.namaBarang;
      document.getElementById('modalNama').textContent = item.namaBarang || '-';
      document.getElementById('modalVolume').textContent = item.volume || 0;
      document.getElementById('modalSatuan').textContent = item.satuan || '-';
      document.getElementById('modalSpek').textContent = item.spesifikasi || '-';
      document.getElementById('calcVol').textContent = item.volume || 0;
      
      // Populate survey data
      document.getElementById('surveyVendor1').value = item.vendor1 || '';
      document.getElementById('surveyHarga1').value = item.harga1 || '';
      document.getElementById('surveyLink1').value = item.link1 || '';
      
      document.getElementById('surveyVendor2').value = item.vendor2 || '';
      document.getElementById('surveyHarga2').value = item.harga2 || '';
      document.getElementById('surveyLink2').value = item.link2 || '';
      
      document.getElementById('surveyVendor3').value = item.vendor3 || '';
      document.getElementById('surveyHarga3').value = item.harga3 || '';
      document.getElementById('surveyLink3').value = item.link3 || '';
      
      document.getElementById('surveyDukung1').value = item.dataDukung1 || '';
      document.getElementById('surveyDukungKet1').value = item.dataDukungKet1 || '';
      document.getElementById('surveyDukung2').value = item.dataDukung2 || '';
      document.getElementById('surveyDukungKet2').value = item.dataDukungKet2 || '';
      
      calcSurvey();
      document.getElementById('modalAlert').classList.add('hidden');
      document.getElementById('surveyModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('surveyModal').classList.remove('active');
      currentItemId = null;
    }

    function calcSurvey() {
      var h1 = parseFloat(document.getElementById('surveyHarga1').value) || 0;
      var h2 = parseFloat(document.getElementById('surveyHarga2').value) || 0;
      var h3 = parseFloat(document.getElementById('surveyHarga3').value) || 0;
      
      var item = currentItems.find(function(x) { return x.itemId === currentItemId; });
      var vol = item ? item.volume : 0;
      
      var prices = [h1, h2, h3].filter(function(p) { return p > 0; });
      var terendah = prices.length > 0 ? Math.min.apply(null, prices) : 0;
      var rata = prices.length > 0 ? prices.reduce(function(a, b) { return a + b; }, 0) / prices.length : 0;
      
      var metode = getMetode();
      var hargaHps = metode === 'terendah' ? terendah : Math.round(rata);
      var total = hargaHps * vol;
      
      document.getElementById('calcTerendah').textContent = formatRupiah(terendah);
      document.getElementById('calcRata').textContent = formatRupiah(Math.round(rata));
      document.getElementById('calcMetode').textContent = metode === 'terendah' ? 'Harga Terendah' : 'Rata-rata';
      document.getElementById('calcHargaHps').textContent = formatRupiah(hargaHps);
      document.getElementById('calcTotal').textContent = formatRupiah(total);
    }

    function saveSurvey() {
      var vendor1 = document.getElementById('surveyVendor1').value.trim();
      var harga1 = parseFloat(document.getElementById('surveyHarga1').value) || 0;
      var vendor2 = document.getElementById('surveyVendor2').value.trim();
      var harga2 = parseFloat(document.getElementById('surveyHarga2').value) || 0;
      var vendor3 = document.getElementById('surveyVendor3').value.trim();
      var harga3 = parseFloat(document.getElementById('surveyHarga3').value) || 0;
      
      // Validation
      if (!vendor1 || harga1 <= 0) { showModalAlert('error', 'Pembanding 1 wajib diisi'); return; }
      if (!vendor2 || harga2 <= 0) { showModalAlert('error', 'Pembanding 2 wajib diisi'); return; }
      if (!vendor3 || harga3 <= 0) { showModalAlert('error', 'Pembanding 3 wajib diisi'); return; }
      
      var item = currentItems.find(function(x) { return x.itemId === currentItemId; });
      if (!item) return;
      
      var btn = document.getElementById('saveBtn');
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';
      
      var data = {
        itemId: currentItemId,
        projectId: currentProject.projectId,
        namaBarang: item.namaBarang,
        spesifikasi: item.spesifikasi,
        volume: item.volume,
        satuan: item.satuan,
        vendor1: vendor1,
        harga1: harga1,
        link1: document.getElementById('surveyLink1').value.trim(),
        vendor2: vendor2,
        harga2: harga2,
        link2: document.getElementById('surveyLink2').value.trim(),
        vendor3: vendor3,
        harga3: harga3,
        link3: document.getElementById('surveyLink3').value.trim(),
        dataDukung1: document.getElementById('surveyDukung1').value.trim(),
        dataDukungKet1: document.getElementById('surveyDukungKet1').value.trim(),
        dataDukung2: document.getElementById('surveyDukung2').value.trim(),
        dataDukungKet2: document.getElementById('surveyDukungKet2').value.trim(),
        metodeHps: getMetode()
      };
      
      fetch(CONFIG.API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'updateItem', data: data })
      })
      .then(function(r) { return r.json(); })
      .then(function(result) {
        btn.disabled = false;
        btn.textContent = 'üíæ Simpan Survey';
        
        if (!result.success) {
          showModalAlert('error', result.error || 'Gagal menyimpan');
          return;
        }
        
        closeModal();
        loadProjectDetail(currentProject.projectId);
      })
      .catch(function(err) {
        btn.disabled = false;
        btn.textContent = 'üíæ Simpan Survey';
        showModalAlert('error', 'Error: ' + err.message);
      });
    }

    function showModalAlert(type, msg) {
      var el = document.getElementById('modalAlert');
      el.className = 'alert alert-' + type;
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    // ========== Preview ==========
    function previewHPS() {
      var completed = currentItems.filter(function(x) { return x.harga1 > 0 && x.harga2 > 0 && x.harga3 > 0; });
      
      if (completed.length === 0) {
        alert('Belum ada item yang dilengkapi survey harga');
        return;
      }
      
      var html = generateHPSDoc();
      document.getElementById('previewContent').innerHTML = html;
      document.getElementById('previewModal').classList.add('active');
    }

    function closePreview() {
      document.getElementById('previewModal').classList.remove('active');
    }

    function printHPS() {
      var content = document.getElementById('previewContent').innerHTML;
      var win = window.open('', '_blank');
      win.document.write('<html><head><title>HPS</title>');
      win.document.write('<style>body{font-family:Arial,sans-serif;padding:20px;font-size:12px;}table{width:100%;border-collapse:collapse;margin:15px 0;}th,td{border:1px solid #333;padding:6px;text-align:left;}th{background:#f0f0f0;}.text-right{text-align:right;}.text-center{text-align:center;}</style>');
      win.document.write('</head><body>');
      win.document.write(content);
      win.document.write('</body></html>');
      win.document.close();
      win.print();
    }

    function generateHPSDoc() {
      var metode = getMetode();
      var total = 0;
      
      var html = '<div style="text-align:center;margin-bottom:20px;">';
      html += '<h3>HARGA PERKIRAAN SENDIRI (HPS)</h3>';
      html += '</div>';
      
      html += '<table style="width:auto;border:none;margin-bottom:20px;">';
      html += '<tr><td style="border:none;width:150px;">Nama Pekerjaan</td><td style="border:none;">: ' + esc(currentProject.namaProject) + '</td></tr>';
      html += '<tr><td style="border:none;">Jenis Pengadaan</td><td style="border:none;">: ' + esc(currentProject.jenisPengadaan) + '</td></tr>';
      html += '<tr><td style="border:none;">Metode HPS</td><td style="border:none;">: ' + (metode === 'terendah' ? 'Harga Terendah' : 'Rata-rata 3 Pembanding') + '</td></tr>';
      html += '</table>';
      
      html += '<table><thead><tr>';
      html += '<th>No</th><th>Uraian Barang/Jasa</th><th>Spesifikasi</th><th>Vol</th><th>Sat</th><th class="text-right">Harga Satuan</th><th class="text-right">Jumlah</th>';
      html += '</tr></thead><tbody>';
      
      var no = 1;
      for (var i = 0; i < currentItems.length; i++) {
        var item = currentItems[i];
        if (!(item.harga1 > 0 && item.harga2 > 0 && item.harga3 > 0)) continue;
        
        var hargaHps = metode === 'terendah' ? (item.hargaTerendah || 0) : (item.hargaRata || 0);
        var jumlah = (item.volume || 0) * hargaHps;
        total += jumlah;
        
        html += '<tr>';
        html += '<td class="text-center">' + no++ + '</td>';
        html += '<td>' + esc(item.namaBarang) + '</td>';
        html += '<td>' + esc(item.spesifikasi || '-') + '</td>';
        html += '<td class="text-center">' + item.volume + '</td>';
        html += '<td>' + esc(item.satuan) + '</td>';
        html += '<td class="text-right">' + formatRupiah(hargaHps) + '</td>';
        html += '<td class="text-right">' + formatRupiah(jumlah) + '</td>';
        html += '</tr>';
      }
      
      html += '</tbody>';
      html += '<tfoot><tr style="font-weight:bold;background:#f0f0f0;">';
      html += '<td colspan="6" class="text-right">TOTAL HPS</td>';
      html += '<td class="text-right">' + formatRupiah(total) + '</td>';
      html += '</tr></tfoot></table>';
      
      html += '<p><strong>Terbilang:</strong> <em>' + terbilang(total) + ' rupiah</em></p>';
      
      html += '<div style="text-align:right;margin-top:50px;">';
      html += '<p>Sorong, ' + formatTanggal(new Date()) + '</p>';
      html += '<p>Pejabat Pembuat Komitmen,</p>';
      html += '<br><br><br>';
      html += '<p><u>________________________</u></p>';
      html += '<p>NIP. </p>';
      html += '</div>';
      
      return html;
    }

    function goToDetail() {
      window.location.href = 'project-detail.html?id=' + currentProject.projectId;
    }

    // ========== Helpers ==========
    function getUrlParam(name) {
      var search = window.location.search;
      if (!search) return null;
      var params = search.substring(1).split('&');
      for (var i = 0; i < params.length; i++) {
        var pair = params[i].split('=');
        if (decodeURIComponent(pair[0]) === name) {
          return pair[1] ? decodeURIComponent(pair[1]) : '';
        }
      }
      return null;
    }

    function esc(str) {
      if (!str) return '';
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function formatRupiah(num) {
      if (!num || isNaN(num)) return 'Rp 0';
      return 'Rp ' + Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    function formatTanggal(d) {
      var bulan = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
      return d.getDate() + ' ' + bulan[d.getMonth()] + ' ' + d.getFullYear();
    }

    function terbilang(n) {
      var bilangan = ['','satu','dua','tiga','empat','lima','enam','tujuh','delapan','sembilan','sepuluh','sebelas'];
      if (n < 12) return bilangan[n];
      if (n < 20) return terbilang(n - 10) + ' belas';
      if (n < 100) return terbilang(Math.floor(n / 10)) + ' puluh ' + terbilang(n % 10);
      if (n < 200) return 'seratus ' + terbilang(n - 100);
      if (n < 1000) return terbilang(Math.floor(n / 100)) + ' ratus ' + terbilang(n % 100);
      if (n < 2000) return 'seribu ' + terbilang(n - 1000);
      if (n < 1000000) return terbilang(Math.floor(n / 1000)) + ' ribu ' + terbilang(n % 1000);
      if (n < 1000000000) return terbilang(Math.floor(n / 1000000)) + ' juta ' + terbilang(n % 1000000);
      return terbilang(Math.floor(n / 1000000000)) + ' miliar ' + terbilang(n % 1000000000);
    }
  </script>
</body>
</html>
