<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BAST - Sistem Pengadaan</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="app-layout">
    
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">üìã SIPBJ</div>
        <div class="sidebar-subtitle">Sistem Informasi Pengadaan<br>Barang & Jasa</div>
      </div>
      <nav class="sidebar-menu">
        <a href="../index.html" class="menu-item"><span class="menu-icon">üè†</span><span class="menu-text">Dashboard</span></a>
        <div class="menu-title">Pengadaan</div>
        <a href="projects.html" class="menu-item"><span class="menu-icon">üìÅ</span><span class="menu-text">Daftar Paket</span></a>
        <div class="menu-title">Dokumen</div>
        <a href="hps.html" class="menu-item"><span class="menu-icon">üìä</span><span class="menu-text">HPS</span></a>
        <a href="spk.html" class="menu-item"><span class="menu-icon">üìù</span><span class="menu-text">SPK/Kontrak</span></a>
        <a href="bapp.html" class="menu-item"><span class="menu-icon">üîç</span><span class="menu-text">BA Pemeriksaan</span></a>
        <a href="bast.html" class="menu-item active"><span class="menu-icon">ü§ù</span><span class="menu-text">BAST</span></a>
        <a href="ba-bayar.html" class="menu-item"><span class="menu-icon">üí≥</span><span class="menu-text">BA Pembayaran</span></a>
        <a href="kuitansi.html" class="menu-item"><span class="menu-icon">üßæ</span><span class="menu-text">Kuitansi</span></a>
        <div class="menu-title">Lainnya</div>
        <a href="settings.html" class="menu-item"><span class="menu-icon">‚öôÔ∏è</span><span class="menu-text">Pengaturan</span></a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      
      <div class="breadcrumb">
        <a href="../index.html">Dashboard</a> / <span>BAST</span>
      </div>

      <div class="page-header">
        <div>
          <h1 class="page-title">ü§ù Berita Acara Serah Terima</h1>
          <p class="page-subtitle">Buat dokumen BAST untuk penyerahan pekerjaan</p>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Form BAST</h2>
        </div>
        <div class="card-body">
          <div id="alertBox" class="alert hidden"></div>
          
          <form id="bastForm">
            <!-- Nomor & Tanggal -->
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Nomor BAST <span class="required">*</span></label>
                <input type="text" id="nomorBast" class="form-control" placeholder="BAST-XXXX/PPK/PL450/XII/2025">
                <button type="button" class="btn btn-secondary btn-sm mt-1" onclick="generateNomor()">üîÑ Generate</button>
              </div>
              <div class="form-group">
                <label class="form-label">Tanggal <span class="required">*</span></label>
                <input type="date" id="tanggalBast" class="form-control">
              </div>
            </div>

            <!-- Pekerjaan -->
            <div class="form-group">
              <label class="form-label">Nama Pekerjaan <span class="required">*</span></label>
              <input type="text" id="namaPekerjaan" class="form-control" placeholder="Pemeliharaan Kapal Latih Airaha 02">
            </div>
            
            <div class="form-group">
              <label class="form-label">Periode/Bulan</label>
              <input type="text" id="periodePekerjaan" class="form-control" placeholder="Desember 2025">
            </div>

            <!-- Pihak Pertama (PPK) -->
            <h3 class="mt-4 mb-2" style="font-size:14px;color:#1976d2;">PIHAK PERTAMA (PPK)</h3>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Nama PPK <span class="required">*</span></label>
                <input type="text" id="namaPpk" class="form-control">
              </div>
              <div class="form-group">
                <label class="form-label">Jabatan</label>
                <input type="text" id="jabatanPpk" class="form-control" value="Pranata Keuangan Mahir">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Dasar SK</label>
              <input type="text" id="skPpk" class="form-control" placeholder="B.170/KPA POLTEK-SORONG/KU.110/VIII/2024">
            </div>

            <!-- Pihak Kedua (Penyedia) -->
            <h3 class="mt-4 mb-2" style="font-size:14px;color:#1976d2;">PIHAK KEDUA (PENYEDIA)</h3>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Nama Penyedia <span class="required">*</span></label>
                <input type="text" id="namaPenyedia" class="form-control" placeholder="CV. CENDRAWASIH JAYA MANDIRI">
              </div>
              <div class="form-group">
                <label class="form-label">Nama Direktur/Pemilik <span class="required">*</span></label>
                <input type="text" id="namaDirektur" class="form-control" placeholder="FECKY IMANUEL MUGU">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Alamat Penyedia</label>
              <input type="text" id="alamatPenyedia" class="form-control" placeholder="Jl. Dewi Sartika RT. 005 RW.004 Majener Salawati">
            </div>

            <!-- Referensi SPK -->
            <h3 class="mt-4 mb-2" style="font-size:14px;color:#1976d2;">REFERENSI DOKUMEN</h3>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Nomor SPK</label>
                <input type="text" id="nomorSpk" class="form-control" placeholder="SPK-XXXX/PPK/PL450/XII/2025">
              </div>
              <div class="form-group">
                <label class="form-label">Tanggal SPK</label>
                <input type="date" id="tanggalSpk" class="form-control">
              </div>
            </div>

          </form>
        </div>
        <div class="card-footer">
          <div class="btn-group">
            <button type="button" class="btn btn-primary" onclick="previewDocument()">üëÅÔ∏è Preview</button>
            <button type="button" class="btn btn-success" onclick="saveAndPrint()">üñ®Ô∏è Simpan & Cetak</button>
          </div>
        </div>
      </div>

      <!-- Preview Section -->
      <div id="previewSection" class="card hidden">
        <div class="card-header">
          <h2 class="card-title">Preview Dokumen</h2>
          <button class="btn btn-secondary btn-sm no-print" onclick="window.print()">üñ®Ô∏è Cetak</button>
        </div>
        <div class="card-body">
          <div class="doc-preview" id="documentPreview"></div>
        </div>
      </div>

    </main>
  </div>

  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/utils.js"></script>
  <script src="../js/institution.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('tanggalBast').value = new Date().toISOString().split('T')[0];
      document.getElementById('namaPpk').value = INSTITUTION.ppinak.nama;
      document.getElementById('jabatanPpk').value = INSTITUTION.ppinak.jabatan;
      document.getElementById('skPpk').value = INSTITUTION.ppinak.skJabatan;
      
      var projectId = Utils.getUrlParam('projectId');
      if (projectId) loadProjectData(projectId);
    });

    function loadProjectData(projectId) {
      API.get('getProjectDetail', { projectId: projectId })
        .then(function(result) {
          if (result.success && result.data) {
            var p = result.data;
            Utils.setValue('namaPekerjaan', p.namaProject);
            if (p.namaPenyedia) Utils.setValue('namaPenyedia', p.namaPenyedia);
            if (p.namaDirektur) Utils.setValue('namaDirektur', p.namaDirektur);
            if (p.alamatPenyedia) Utils.setValue('alamatPenyedia', p.alamatPenyedia);
          }
        });
    }

    function generateNomor() {
      var nomor = Utils.generateNomorDokumen('BAST', INSTITUTION.kodeSatker);
      document.getElementById('nomorBast').value = nomor;
    }

    function previewDocument() {
      var data = getFormData();
      if (!validateForm(data)) return;
      
      var html = renderBASTDocument(data);
      document.getElementById('documentPreview').innerHTML = html;
      Utils.show('previewSection');
      document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
    }

    function getFormData() {
      return {
        nomor: Utils.getValue('nomorBast'),
        tanggal: Utils.getValue('tanggalBast'),
        namaPekerjaan: Utils.getValue('namaPekerjaan'),
        periode: Utils.getValue('periodePekerjaan'),
        namaPpk: Utils.getValue('namaPpk'),
        jabatanPpk: Utils.getValue('jabatanPpk'),
        skPpk: Utils.getValue('skPpk'),
        namaPenyedia: Utils.getValue('namaPenyedia'),
        namaDirektur: Utils.getValue('namaDirektur'),
        alamatPenyedia: Utils.getValue('alamatPenyedia'),
        nomorSpk: Utils.getValue('nomorSpk'),
        tanggalSpk: Utils.getValue('tanggalSpk')
      };
    }

    function validateForm(data) {
      if (!data.nomor) { showAlert('error', 'Nomor BAST wajib diisi'); return false; }
      if (!data.tanggal) { showAlert('error', 'Tanggal wajib diisi'); return false; }
      if (!data.namaPekerjaan) { showAlert('error', 'Nama pekerjaan wajib diisi'); return false; }
      if (!data.namaPpk) { showAlert('error', 'Nama PPK wajib diisi'); return false; }
      if (!data.namaPenyedia) { showAlert('error', 'Nama penyedia wajib diisi'); return false; }
      if (!data.namaDirektur) { showAlert('error', 'Nama direktur wajib diisi'); return false; }
      return true;
    }

    function renderBASTDocument(data) {
      var tanggalFormatted = Utils.formatDate(data.tanggal);
      var tanggalSpkFormatted = data.tanggalSpk ? Utils.formatDate(data.tanggalSpk) : '-';
      
      return '<div class="doc-header">' +
        '<table style="width:100%;border:none;">' +
        '<tr><td style="width:80px;vertical-align:top;border:none;padding:0;"></td>' +
        '<td style="text-align:center;border:none;padding:0;">' +
        '<div class="doc-kementerian">' + INSTITUTION.kementerian + '</div>' +
        '<div class="doc-badan">' + INSTITUTION.badan + '</div>' +
        '<div class="doc-satker">' + INSTITUTION.satker + '</div>' +
        '<div class="doc-alamat">' + INSTITUTION.alamat + '</div>' +
        '<div class="doc-alamat">' + INSTITUTION.kotakPos + '</div>' +
        '<div class="doc-alamat">LAMAN ' + INSTITUTION.website + ' SUREL ' + INSTITUTION.email + '</div>' +
        '</td></tr></table></div>' +
        
        '<div class="doc-title">' +
        '<h2>BERITA ACARA SERAH TERIMA PEKERJAAN</h2>' +
        '<p><strong><em>' + Utils.escapeHtml(data.namaPekerjaan) + '</em></strong></p>' +
        '<p>NO : ' + Utils.escapeHtml(data.nomor) + '</p></div>' +
        
        '<div class="doc-body">' +
        '<p>Pada hari ini tanggal ' + tanggalFormatted + ', kami yang bertanda tangan di bawah ini :</p>' +
        
        '<table style="margin:20px 0;border:none;width:100%;">' +
        '<tr><td style="width:20px;vertical-align:top;border:none;">1.</td>' +
        '<td style="border:none;"><strong>' + Utils.escapeHtml(data.namaPpk) + '</strong><br>' +
        Utils.escapeHtml(data.jabatanPpk) + ' pada ' + INSTITUTION.satker + ' berdasarkan Keputusan ' + Utils.escapeHtml(data.skPpk) + ', dalam hal ini bertindak untuk dan atas nama ' + INSTITUTION.satker + ' ' + INSTITUTION.kementerian + ', selanjutnya disebut <strong>PIHAK PERTAMA</strong>.</td></tr>' +
        '<tr><td colspan="2" style="border:none;height:15px;"></td></tr>' +
        '<tr><td style="width:20px;vertical-align:top;border:none;">2.</td>' +
        '<td style="border:none;"><strong>' + Utils.escapeHtml(data.namaDirektur) + '</strong><br>' +
        'Direktur, dalam hal ini bertindak untuk dan atas nama ' + Utils.escapeHtml(data.namaPenyedia) + ', yang berkedudukan di ' + Utils.escapeHtml(data.alamatPenyedia) + ' yang selanjutnya disebut <strong>PIHAK KEDUA</strong>.</td></tr></table>' +
        
        '<p>Menyatakan bahwa:</p>' +
        
        '<table style="margin:20px 0;border:none;width:100%;">' +
        '<tr><td style="width:20px;vertical-align:top;border:none;">1.</td>' +
        '<td style="border:none;"><strong>PIHAK KEDUA</strong> telah menyelesaikan pekerjaan: ' + Utils.escapeHtml(data.namaPekerjaan) + ' untuk bulan ' + Utils.escapeHtml(data.periode) + ' sesuai dengan Surat Perjanjian Nomor ' + Utils.escapeHtml(data.nomorSpk) + ' tanggal ' + tanggalSpkFormatted + '.</td></tr>' +
        '<tr><td colspan="2" style="border:none;height:10px;"></td></tr>' +
        '<tr><td style="width:20px;vertical-align:top;border:none;">2.</td>' +
        '<td style="border:none;"><strong>PIHAK PERTAMA</strong> telah menerima dengan baik hasil pekerjaan tersebut.</td></tr></table>' +
        
        '<p>Demikian Berita Acara Serah Terima ini dibuat untuk dipergunakan sebagaimana mestinya.</p></div>' +
        
        '<div class="doc-signature"><div class="doc-signature-row">' +
        '<div class="doc-signature-col"><p>PIHAK KEDUA,</p><p class="doc-signature-name">' + Utils.escapeHtml(data.namaDirektur) + '</p></div>' +
        '<div class="doc-signature-col"><p>PIHAK PERTAMA,</p><p class="doc-signature-name">' + Utils.escapeHtml(data.namaPpk) + '</p></div>' +
        '</div></div>';
    }

    function saveAndPrint() {
      var data = getFormData();
      if (!validateForm(data)) return;
      previewDocument();
      setTimeout(function() { window.print(); }, 500);
    }

    function showAlert(type, msg) {
      var el = document.getElementById('alertBox');
      el.className = 'alert alert-' + type;
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(function() { el.classList.add('hidden'); }, 3000);
    }
  </script>
</body>
</html>
