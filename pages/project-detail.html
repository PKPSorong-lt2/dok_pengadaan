<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detail Paket - Sistem Pengadaan</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="app-layout">
    
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">ğŸ“‹ SIPBJ</div>
        <div class="sidebar-subtitle">Sistem Informasi Pengadaan<br>Barang & Jasa</div>
      </div>
      <nav class="sidebar-menu">
        <a href="../index.html" class="menu-item"><span class="menu-icon">ğŸ </span><span class="menu-text">Dashboard</span></a>
        <div class="menu-title">Pengadaan</div>
        <a href="projects.html" class="menu-item active"><span class="menu-icon">ğŸ“</span><span class="menu-text">Daftar Paket</span></a>
        <a href="project-new.html" class="menu-item"><span class="menu-icon">â•</span><span class="menu-text">Buat Paket Baru</span></a>
        <div class="menu-title">Dokumen</div>
        <a href="hps.html" class="menu-item"><span class="menu-icon">ğŸ“Š</span><span class="menu-text">HPS</span></a>
        <a href="bapp.html" class="menu-item"><span class="menu-icon">ğŸ”</span><span class="menu-text">BA Pemeriksaan</span></a>
        <a href="bast.html" class="menu-item"><span class="menu-icon">ğŸ¤</span><span class="menu-text">BAST</span></a>
        <a href="ba-bayar.html" class="menu-item"><span class="menu-icon">ğŸ’³</span><span class="menu-text">BA Pembayaran</span></a>
        <a href="kuitansi.html" class="menu-item"><span class="menu-icon">ğŸ§¾</span><span class="menu-text">Kuitansi</span></a>
        <div class="menu-title">Lainnya</div>
        <a href="settings.html" class="menu-item"><span class="menu-icon">âš™ï¸</span><span class="menu-text">Pengaturan</span></a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      
      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <a href="../index.html">Dashboard</a> / <a href="projects.html">Daftar Paket</a> / <span id="breadcrumbTitle">Detail</span>
      </div>

      <!-- Status Box -->
      <div id="statusBox" class="alert alert-info">
        <span id="statusText">Memuat data...</span>
      </div>

      <!-- Content (hidden initially) -->
      <div id="contentContainer" style="display:none;">
        
        <!-- Page Header -->
        <div class="page-header">
          <div>
            <h1 class="page-title" id="pageTitle">Detail Paket</h1>
            <p class="page-subtitle" id="projectIdText">-</p>
          </div>
          <div class="btn-group">
            <a href="projects.html" class="btn btn-secondary">â† Kembali</a>
          </div>
        </div>

        <!-- Project Info -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">ğŸ“‹ Informasi Paket</h2>
          </div>
          <div class="card-body">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Nama Paket</label>
                <div id="infoNama" class="form-control" style="background:#f8f9fa;border:none;">-</div>
              </div>
              <div class="form-group">
                <label class="form-label">Jenis Pengadaan</label>
                <div id="infoJenis" class="form-control" style="background:#f8f9fa;border:none;">-</div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Unit Pengusul</label>
                <div id="infoUnit" class="form-control" style="background:#f8f9fa;border:none;">-</div>
              </div>
              <div class="form-group">
                <label class="form-label">Pagu Anggaran</label>
                <div id="infoPagu" class="form-control" style="background:#fff3e0;border:none;font-weight:600;color:#e65100;">-</div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Keterangan</label>
              <div id="infoKeterangan" class="form-control" style="background:#f8f9fa;border:none;min-height:40px;">-</div>
            </div>
          </div>
        </div>

        <!-- Items / Daftar Barang -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">ğŸ“¦ Daftar Barang / Pekerjaan</h2>
            <button class="btn btn-primary btn-sm" onclick="openAddModal()">â• Tambah Item</button>
          </div>
          <div class="card-body">
            
            <!-- Empty state -->
            <div id="itemsEmpty" class="empty-state" style="display:none;">
              <div class="empty-state-icon">ğŸ“­</div>
              <h3 class="empty-state-title">Belum ada item</h3>
              <p class="empty-state-text">Tambahkan item barang/pekerjaan untuk paket ini</p>
              <button class="btn btn-primary" onclick="openAddModal()">â• Tambah Item</button>
            </div>
            
            <!-- Items table -->
            <div id="itemsTableContainer" style="display:none;">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th style="width:40px;">No</th>
                      <th>Nama Barang/Pekerjaan</th>
                      <th>Spesifikasi</th>
                      <th class="text-right">Volume</th>
                      <th>Satuan</th>
                      <th class="text-center">Status HPS</th>
                      <th class="text-right">Jumlah HPS</th>
                      <th style="width:100px;">Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="itemsTable"></tbody>
                  <tfoot id="tableFoot" style="display:none;">
                    <tr style="background:#e3f2fd;font-weight:600;">
                      <td colspan="6" class="text-right">TOTAL HPS:</td>
                      <td class="text-right" id="totalHps">Rp 0</td>
                      <td></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
              
              <!-- Pagu Warning -->
              <div id="paguWarning" class="alert alert-error mt-2" style="display:none;">
                âš ï¸ <strong>PERINGATAN:</strong> Total HPS melebihi Pagu Anggaran! Perlu penyesuaian volume atau harga.
              </div>
              
              <!-- HPS Status -->
              <div id="hpsStatus" class="alert alert-info mt-2" style="display:none;"></div>
            </div>
            
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
          <div class="card-header"><h2 class="card-title">ğŸš€ Langkah Selanjutnya</h2></div>
          <div class="card-body">
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
              <button class="btn btn-primary" onclick="goToHPS()" id="btnHPS">
                ğŸ“Š Lengkapi Survey Harga (HPS)
              </button>
              <span class="form-hint">â†’ Setelah item lengkap, lakukan survey harga 3 pembanding di halaman HPS</span>
            </div>
          </div>
        </div>

      </div>

    </main>
  </div>

  <!-- Modal Tambah Item (Sederhana) -->
  <div id="addItemModal" class="modal">
    <div class="modal-content" style="max-width:600px;">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Tambah Item Barang/Pekerjaan</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="modalAlert" class="alert hidden"></div>
        
        <div class="form-group">
          <label class="form-label">Nama Barang/Pekerjaan <span class="required">*</span></label>
          <input type="text" id="itemNama" class="form-control" placeholder="Kertas HVS A4 80 gram">
        </div>
        
        <div class="form-group">
          <label class="form-label">Spesifikasi Teknis</label>
          <textarea id="itemSpek" class="form-control" rows="3" placeholder="Contoh: 80 gram, 500 lembar per rim, warna putih, merk standar"></textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Volume <span class="required">*</span></label>
            <input type="number" id="itemVolume" class="form-control" min="1" placeholder="10">
          </div>
          <div class="form-group">
            <label class="form-label">Satuan <span class="required">*</span></label>
            <input type="text" id="itemSatuan" class="form-control" placeholder="rim / unit / paket / ls">
          </div>
        </div>
        
        <div class="alert alert-info">
          ğŸ’¡ <strong>Catatan:</strong> Harga akan diisi di halaman HPS dengan survey 3 pembanding
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Batal</button>
        <button class="btn btn-primary" id="saveItemBtn" onclick="saveItem()">ğŸ’¾ Simpan Item</button>
      </div>
    </div>
  </div>

  <!-- Modal Edit Item -->
  <div id="editItemModal" class="modal">
    <div class="modal-content" style="max-width:600px;">
      <div class="modal-header">
        <h3 class="modal-title">Edit Item</h3>
        <button class="modal-close" onclick="closeEditModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="editModalAlert" class="alert hidden"></div>
        <input type="hidden" id="editItemId">
        
        <div class="form-group">
          <label class="form-label">Nama Barang/Pekerjaan <span class="required">*</span></label>
          <input type="text" id="editItemNama" class="form-control">
        </div>
        
        <div class="form-group">
          <label class="form-label">Spesifikasi Teknis</label>
          <textarea id="editItemSpek" class="form-control" rows="3"></textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Volume <span class="required">*</span></label>
            <input type="number" id="editItemVolume" class="form-control" min="1">
          </div>
          <div class="form-group">
            <label class="form-label">Satuan <span class="required">*</span></label>
            <input type="text" id="editItemSatuan" class="form-control">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEditModal()">Batal</button>
        <button class="btn btn-primary" id="updateItemBtn" onclick="updateItem()">ğŸ’¾ Update</button>
      </div>
    </div>
  </div>

  <script src="../js/config.js"></script>
  <script>
    var projectId = '';
    var projectData = null;
    var paguAnggaran = 0;

    document.addEventListener('DOMContentLoaded', function() {
      projectId = getUrlParam('id');
      console.log('Project ID:', projectId);
      
      if (!projectId) {
        setStatus('âŒ ID Paket tidak ditemukan', 'error');
        return;
      }
      
      loadProject();
    });

    function getUrlParam(name) {
      var search = window.location.search;
      if (!search) return null;
      var params = search.substring(1).split('&');
      for (var i = 0; i < params.length; i++) {
        var pair = params[i].split('=');
        if (decodeURIComponent(pair[0]) === name) {
          return pair[1] ? decodeURIComponent(pair[1]) : '';
        }
      }
      return null;
    }

    function setStatus(msg, type) {
      var box = document.getElementById('statusBox');
      var text = document.getElementById('statusText');
      text.innerHTML = msg;
      box.className = 'alert alert-' + (type || 'info');
      box.style.display = 'block';
    }

    function loadProject() {
      console.log('Loading project:', projectId);
      setStatus('Memuat data paket...', 'info');
      
      var url = CONFIG.API_URL + '?action=getProjectDetail&projectId=' + encodeURIComponent(projectId);
      
      fetch(url, { method: 'GET', redirect: 'follow' })
        .then(function(response) { return response.json(); })
        .then(function(result) {
          if (!result.success) {
            setStatus('âŒ Error: ' + (result.error || 'Unknown'), 'error');
            return;
          }
          
          projectData = result.data;
          
          if (!projectData) {
            setStatus('âŒ Paket tidak ditemukan', 'error');
            return;
          }
          
          renderProject();
          document.getElementById('statusBox').style.display = 'none';
          document.getElementById('contentContainer').style.display = 'block';
        })
        .catch(function(err) {
          setStatus('âŒ Network error: ' + err.message, 'error');
        });
    }

    function renderProject() {
      var p = projectData;
      
      // Breadcrumb & Title
      document.getElementById('breadcrumbTitle').textContent = p.namaProject || 'Detail';
      document.getElementById('pageTitle').textContent = p.namaProject || '-';
      document.getElementById('projectIdText').textContent = p.projectId || '';
      
      // Info
      document.getElementById('infoNama').textContent = p.namaProject || '-';
      document.getElementById('infoJenis').textContent = p.jenisPengadaan || 'Pengadaan Langsung';
      document.getElementById('infoUnit').textContent = p.unit || '-';
      document.getElementById('infoKeterangan').textContent = p.keterangan || '-';
      
      // Pagu Anggaran
      paguAnggaran = p.paguAnggaran || p.nilaiKontrak || 0;
      document.getElementById('infoPagu').textContent = formatRupiah(paguAnggaran);
      
      // Items
      renderItems(p.items || []);
    }

    function renderItems(items) {
      if (!items || items.length === 0) {
        document.getElementById('itemsEmpty').style.display = 'block';
        document.getElementById('itemsTableContainer').style.display = 'none';
        return;
      }
      
      document.getElementById('itemsEmpty').style.display = 'none';
      document.getElementById('itemsTableContainer').style.display = 'block';
      
      var tbody = document.getElementById('itemsTable');
      var html = '';
      var totalHps = 0;
      var itemsWithHps = 0;
      
      for (var i = 0; i < items.length; i++) {
        var item = items[i];
        var jumlah = item.jumlahHps || 0;
        totalHps += jumlah;
        
        // Check if item has HPS completed
        var hasHps = item.harga1 > 0 && item.harga2 > 0 && item.harga3 > 0;
        if (hasHps) itemsWithHps++;
        
        var statusBadge = hasHps 
          ? '<span class="badge badge-success">âœ“ Lengkap</span>'
          : '<span class="badge badge-warning">Belum Survey</span>';
        
        html += '<tr>';
        html += '<td>' + (i + 1) + '</td>';
        html += '<td>' + escapeHtml(item.namaBarang || '-') + '</td>';
        html += '<td><small>' + escapeHtml(item.spesifikasi || '-') + '</small></td>';
        html += '<td class="text-right">' + (item.volume || 0) + '</td>';
        html += '<td>' + escapeHtml(item.satuan || '-') + '</td>';
        html += '<td class="text-center">' + statusBadge + '</td>';
        html += '<td class="text-right">' + (hasHps ? formatRupiah(jumlah) : '-') + '</td>';
        html += '<td>';
        html += '<button class="btn btn-secondary btn-sm" onclick="editItemModal(\'' + item.itemId + '\')">âœï¸</button> ';
        html += '<button class="btn btn-danger btn-sm" onclick="deleteItem(\'' + item.itemId + '\')">ğŸ—‘ï¸</button>';
        html += '</td>';
        html += '</tr>';
      }
      
      tbody.innerHTML = html;
      
      // Show total if any item has HPS
      if (itemsWithHps > 0) {
        document.getElementById('tableFoot').style.display = '';
        document.getElementById('totalHps').textContent = formatRupiah(totalHps);
        
        // Check pagu
        if (paguAnggaran > 0 && totalHps > paguAnggaran) {
          document.getElementById('paguWarning').style.display = 'block';
        } else {
          document.getElementById('paguWarning').style.display = 'none';
        }
      } else {
        document.getElementById('tableFoot').style.display = 'none';
        document.getElementById('paguWarning').style.display = 'none';
      }
      
      // HPS Status
      var hpsStatusEl = document.getElementById('hpsStatus');
      if (items.length > 0) {
        if (itemsWithHps === items.length) {
          hpsStatusEl.className = 'alert alert-success mt-2';
          hpsStatusEl.innerHTML = 'âœ… Semua item sudah dilengkapi survey harga HPS';
        } else {
          hpsStatusEl.className = 'alert alert-warning mt-2';
          hpsStatusEl.innerHTML = 'â³ ' + itemsWithHps + ' dari ' + items.length + ' item sudah dilengkapi survey harga. <a href="hps.html?id=' + projectId + '">Lengkapi di HPS â†’</a>';
        }
        hpsStatusEl.style.display = 'block';
      } else {
        hpsStatusEl.style.display = 'none';
      }
    }

    // ========== Modal Add Item ==========
    function openAddModal() {
      document.getElementById('itemNama').value = '';
      document.getElementById('itemSpek').value = '';
      document.getElementById('itemVolume').value = '';
      document.getElementById('itemSatuan').value = '';
      document.getElementById('modalAlert').classList.add('hidden');
      document.getElementById('addItemModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('addItemModal').classList.remove('active');
    }

    function saveItem() {
      var nama = document.getElementById('itemNama').value.trim();
      var spek = document.getElementById('itemSpek').value.trim();
      var volume = parseInt(document.getElementById('itemVolume').value) || 0;
      var satuan = document.getElementById('itemSatuan').value.trim();
      
      // Validation
      if (!nama) { showModalAlert('error', 'Nama barang wajib diisi'); return; }
      if (volume <= 0) { showModalAlert('error', 'Volume harus lebih dari 0'); return; }
      if (!satuan) { showModalAlert('error', 'Satuan wajib diisi'); return; }
      
      var btn = document.getElementById('saveItemBtn');
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';
      
      var data = {
        projectId: projectId,
        namaBarang: nama,
        spesifikasi: spek,
        volume: volume,
        satuan: satuan,
        // Harga kosong - akan diisi di HPS
        harga1: 0,
        harga2: 0,
        harga3: 0
      };
      
      fetch(CONFIG.API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'addItem', data: data })
      })
      .then(function(r) { return r.json(); })
      .then(function(result) {
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ Simpan Item';
        
        if (!result.success) {
          showModalAlert('error', result.error || 'Gagal menyimpan');
          return;
        }
        
        closeModal();
        loadProject();
      })
      .catch(function(err) {
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ Simpan Item';
        showModalAlert('error', 'Error: ' + err.message);
      });
    }

    function showModalAlert(type, msg) {
      var el = document.getElementById('modalAlert');
      el.className = 'alert alert-' + type;
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    // ========== Modal Edit Item ==========
    function editItemModal(itemId) {
      var item = (projectData.items || []).find(function(x) { return x.itemId === itemId; });
      if (!item) return;
      
      document.getElementById('editItemId').value = itemId;
      document.getElementById('editItemNama').value = item.namaBarang || '';
      document.getElementById('editItemSpek').value = item.spesifikasi || '';
      document.getElementById('editItemVolume').value = item.volume || '';
      document.getElementById('editItemSatuan').value = item.satuan || '';
      document.getElementById('editModalAlert').classList.add('hidden');
      document.getElementById('editItemModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editItemModal').classList.remove('active');
    }

    function updateItem() {
      var itemId = document.getElementById('editItemId').value;
      var nama = document.getElementById('editItemNama').value.trim();
      var spek = document.getElementById('editItemSpek').value.trim();
      var volume = parseInt(document.getElementById('editItemVolume').value) || 0;
      var satuan = document.getElementById('editItemSatuan').value.trim();
      
      if (!nama) { showEditAlert('error', 'Nama barang wajib diisi'); return; }
      if (volume <= 0) { showEditAlert('error', 'Volume harus lebih dari 0'); return; }
      if (!satuan) { showEditAlert('error', 'Satuan wajib diisi'); return; }
      
      var btn = document.getElementById('updateItemBtn');
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';
      
      // Get existing item to preserve HPS data
      var existingItem = (projectData.items || []).find(function(x) { return x.itemId === itemId; });
      
      var data = {
        itemId: itemId,
        projectId: projectId,
        namaBarang: nama,
        spesifikasi: spek,
        volume: volume,
        satuan: satuan,
        // Preserve existing HPS data
        harga1: existingItem ? existingItem.harga1 : 0,
        harga2: existingItem ? existingItem.harga2 : 0,
        harga3: existingItem ? existingItem.harga3 : 0,
        vendor1: existingItem ? existingItem.vendor1 : '',
        vendor2: existingItem ? existingItem.vendor2 : '',
        vendor3: existingItem ? existingItem.vendor3 : ''
      };
      
      fetch(CONFIG.API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'updateItem', data: data })
      })
      .then(function(r) { return r.json(); })
      .then(function(result) {
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ Update';
        
        if (!result.success) {
          showEditAlert('error', result.error || 'Gagal update');
          return;
        }
        
        closeEditModal();
        loadProject();
      })
      .catch(function(err) {
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ Update';
        showEditAlert('error', 'Error: ' + err.message);
      });
    }

    function showEditAlert(type, msg) {
      var el = document.getElementById('editModalAlert');
      el.className = 'alert alert-' + type;
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    // ========== Delete Item ==========
    function deleteItem(itemId) {
      if (!confirm('Hapus item ini?')) return;
      
      fetch(CONFIG.API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'deleteItem', data: { projectId: projectId, itemId: itemId } })
      })
      .then(function(r) { return r.json(); })
      .then(function(result) {
        if (result.success) {
          loadProject();
        } else {
          alert('Gagal hapus: ' + result.error);
        }
      });
    }

    // ========== Navigation ==========
    function goToHPS() {
      window.location.href = 'hps.html?id=' + projectId;
    }

    // ========== Helpers ==========
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
    
    function formatRupiah(num) {
      if (!num || isNaN(num)) return 'Rp 0';
      return 'Rp ' + Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }
  </script>
</body>
</html>
