<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detail Paket - Sistem Pengadaan</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="app-layout">
    
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">ğŸ“‹ SIPBJ</div>
        <div class="sidebar-subtitle">Sistem Informasi Pengadaan<br>Barang & Jasa</div>
      </div>
      <nav class="sidebar-menu">
        <a href="../index.html" class="menu-item"><span class="menu-icon">ğŸ </span><span class="menu-text">Dashboard</span></a>
        <div class="menu-title">Pengadaan</div>
        <a href="projects.html" class="menu-item active"><span class="menu-icon">ğŸ“</span><span class="menu-text">Daftar Paket</span></a>
        <a href="project-new.html" class="menu-item"><span class="menu-icon">â•</span><span class="menu-text">Buat Paket Baru</span></a>
        <div class="menu-title">Dokumen</div>
        <a href="hps.html" class="menu-item"><span class="menu-icon">ğŸ“Š</span><span class="menu-text">HPS</span></a>
        <a href="bapp.html" class="menu-item"><span class="menu-icon">ğŸ”</span><span class="menu-text">BA Pemeriksaan</span></a>
        <a href="bast.html" class="menu-item"><span class="menu-icon">ğŸ¤</span><span class="menu-text">BAST</span></a>
        <a href="ba-bayar.html" class="menu-item"><span class="menu-icon">ğŸ’³</span><span class="menu-text">BA Pembayaran</span></a>
        <a href="kuitansi.html" class="menu-item"><span class="menu-icon">ğŸ§¾</span><span class="menu-text">Kuitansi</span></a>
        <div class="menu-title">Lainnya</div>
        <a href="settings.html" class="menu-item"><span class="menu-icon">âš™ï¸</span><span class="menu-text">Pengaturan</span></a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      
      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <a href="../index.html">Dashboard</a> / <a href="projects.html">Daftar Paket</a> / <span id="breadcrumbTitle">Detail</span>
      </div>

      <!-- Status Box -->
      <div id="statusBox" class="alert alert-info">
        <span id="statusText">Memuat data...</span>
      </div>

      <!-- Content (hidden initially) -->
      <div id="contentContainer" style="display:none;">
        
        <!-- Page Header -->
        <div class="page-header">
          <div>
            <h1 class="page-title" id="pageTitle">Detail Paket</h1>
            <p class="page-subtitle" id="projectIdText">-</p>
          </div>
          <div class="btn-group">
            <a href="projects.html" class="btn btn-secondary">â† Kembali</a>
          </div>
        </div>

        <!-- Project Info -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">ğŸ“‹ Informasi Paket</h2>
          </div>
          <div class="card-body">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Nama Paket</label>
                <div id="infoNama" class="form-control" style="background:#f8f9fa;border:none;">-</div>
              </div>
              <div class="form-group">
                <label class="form-label">Jenis Pengadaan</label>
                <div id="infoJenis" class="form-control" style="background:#f8f9fa;border:none;">-</div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Unit Pengusul</label>
                <div id="infoUnit" class="form-control" style="background:#f8f9fa;border:none;">-</div>
              </div>
              <div class="form-group">
                <label class="form-label">Sumber Dana</label>
                <div id="infoSumberDana" class="form-control" style="background:#f8f9fa;border:none;">-</div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Penyedia</label>
                <div id="infoPenyedia" class="form-control" style="background:#f8f9fa;border:none;">-</div>
              </div>
              <div class="form-group">
                <label class="form-label">Nilai HPS</label>
                <div id="infoNilai" class="form-control" style="background:#f8f9fa;border:none;font-weight:600;color:#1976d2;">-</div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Keterangan</label>
              <div id="infoKeterangan" class="form-control" style="background:#f8f9fa;border:none;min-height:60px;">-</div>
            </div>
          </div>
        </div>

        <!-- Items / Daftar Barang -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">ğŸ“¦ Daftar Barang / Pekerjaan</h2>
            <button class="btn btn-primary btn-sm" onclick="window.location.href='hps.html?id='+projectId">â• Kelola di HPS</button>
          </div>
          <div class="card-body">
            
            <!-- Empty state -->
            <div id="itemsEmpty" class="empty-state" style="display:none;">
              <div class="empty-state-icon">ğŸ“­</div>
              <h3 class="empty-state-title">Belum ada item</h3>
              <p class="empty-state-text">Tambahkan item melalui halaman HPS</p>
              <button class="btn btn-primary" onclick="window.location.href='hps.html?id='+projectId">ğŸ“Š Buka HPS</button>
            </div>
            
            <!-- Items table -->
            <div id="itemsTableContainer" style="display:none;">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th style="width:40px;">No</th>
                      <th>Nama Barang/Pekerjaan</th>
                      <th>Spesifikasi</th>
                      <th class="text-right">Volume</th>
                      <th>Satuan</th>
                      <th class="text-right">Harga Satuan</th>
                      <th class="text-right">Jumlah</th>
                    </tr>
                  </thead>
                  <tbody id="itemsTable"></tbody>
                  <tfoot>
                    <tr style="background:#e3f2fd;font-weight:600;">
                      <td colspan="6" class="text-right">TOTAL HPS:</td>
                      <td class="text-right" id="totalHps">Rp 0</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
            
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">ğŸ“„ Buat Dokumen</h2>
          </div>
          <div class="card-body">
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn btn-secondary" onclick="goToDoc('hps')">ğŸ“Š HPS</button>
              <button class="btn btn-secondary" onclick="goToDoc('bapp')">ğŸ” BA Pemeriksaan</button>
              <button class="btn btn-secondary" onclick="goToDoc('bast')">ğŸ¤ BAST</button>
              <button class="btn btn-secondary" onclick="goToDoc('ba-bayar')">ğŸ’³ BA Pembayaran</button>
              <button class="btn btn-secondary" onclick="goToDoc('kuitansi')">ğŸ§¾ Kuitansi</button>
            </div>
          </div>
        </div>

      </div>

    </main>
  </div>

  <script src="../js/config.js"></script>
  <script>
    var projectId = '';
    var projectData = null;

    document.addEventListener('DOMContentLoaded', function() {
      // Get project ID from URL
      projectId = getUrlParam('id');
      console.log('Project ID:', projectId);
      
      if (!projectId) {
        setStatus('âŒ ID Paket tidak ditemukan', 'error');
        return;
      }
      
      loadProject();
    });

    function getUrlParam(name) {
      var search = window.location.search;
      if (!search) return null;
      var params = search.substring(1).split('&');
      for (var i = 0; i < params.length; i++) {
        var pair = params[i].split('=');
        if (decodeURIComponent(pair[0]) === name) {
          return pair[1] ? decodeURIComponent(pair[1]) : '';
        }
      }
      return null;
    }

    function setStatus(msg, type) {
      var box = document.getElementById('statusBox');
      var text = document.getElementById('statusText');
      text.innerHTML = msg;
      box.className = 'alert alert-' + (type || 'info');
      box.style.display = 'block';
    }

    function loadProject() {
      console.log('Loading project:', projectId);
      setStatus('Memuat data paket...', 'info');
      
      var url = CONFIG.API_URL + '?action=getProjectDetail&projectId=' + encodeURIComponent(projectId);
      console.log('Fetching:', url);
      
      fetch(url, { method: 'GET', redirect: 'follow' })
        .then(function(response) {
          console.log('Response status:', response.status);
          return response.text();
        })
        .then(function(text) {
          console.log('Response:', text);
          
          try {
            var result = JSON.parse(text);
            
            if (!result.success) {
              setStatus('âŒ Error: ' + (result.error || 'Unknown'), 'error');
              return;
            }
            
            projectData = result.data;
            console.log('Project data:', projectData);
            
            if (!projectData) {
              setStatus('âŒ Paket tidak ditemukan', 'error');
              return;
            }
            
            // Render
            renderProject();
            
            // Hide status, show content
            document.getElementById('statusBox').style.display = 'none';
            document.getElementById('contentContainer').style.display = 'block';
            
          } catch (e) {
            console.log('Parse error:', e);
            setStatus('âŒ Gagal parse response', 'error');
          }
        })
        .catch(function(err) {
          console.log('Fetch error:', err);
          setStatus('âŒ Network error: ' + err.message, 'error');
        });
    }

    function renderProject() {
      var p = projectData;
      
      // Breadcrumb & Title
      document.getElementById('breadcrumbTitle').textContent = p.namaProject || 'Detail';
      document.getElementById('pageTitle').textContent = p.namaProject || '-';
      document.getElementById('projectIdText').textContent = p.projectId || '';
      
      // Info
      document.getElementById('infoNama').textContent = p.namaProject || '-';
      document.getElementById('infoJenis').textContent = p.jenisPengadaan || 'Pengadaan Langsung';
      document.getElementById('infoUnit').textContent = p.unit || '-';
      document.getElementById('infoSumberDana').textContent = p.sumberDana || 'APBN';
      document.getElementById('infoPenyedia').textContent = p.namaPenyedia || '-';
      document.getElementById('infoNilai').textContent = formatRupiah(p.nilaiKontrak || 0);
      document.getElementById('infoKeterangan').textContent = p.keterangan || '-';
      
      // Items
      renderItems(p.items || []);
    }

    function renderItems(items) {
      console.log('Rendering items:', items.length);
      
      if (!items || items.length === 0) {
        document.getElementById('itemsEmpty').style.display = 'block';
        document.getElementById('itemsTableContainer').style.display = 'none';
        return;
      }
      
      document.getElementById('itemsEmpty').style.display = 'none';
      document.getElementById('itemsTableContainer').style.display = 'block';
      
      var tbody = document.getElementById('itemsTable');
      var html = '';
      var total = 0;
      
      for (var i = 0; i < items.length; i++) {
        var item = items[i];
        var hargaSatuan = item.hargaSatuan || item.harga || 0;
        var volume = item.volume || 0;
        var jumlah = item.jumlahHps || (volume * hargaSatuan);
        total += jumlah;
        
        html += '<tr>';
        html += '<td>' + (i + 1) + '</td>';
        html += '<td>' + escapeHtml(item.namaBarang || '-') + '</td>';
        html += '<td>' + escapeHtml(item.spesifikasi || '-') + '</td>';
        html += '<td class="text-right">' + volume + '</td>';
        html += '<td>' + escapeHtml(item.satuan || '-') + '</td>';
        html += '<td class="text-right">' + formatRupiah(hargaSatuan) + '</td>';
        html += '<td class="text-right">' + formatRupiah(jumlah) + '</td>';
        html += '</tr>';
      }
      
      tbody.innerHTML = html;
      document.getElementById('totalHps').textContent = formatRupiah(total);
    }

    function goToDoc(type) {
      window.location.href = type + '.html?id=' + projectId;
    }

    // Helpers
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
    
    function formatRupiah(num) {
      if (!num || isNaN(num)) return 'Rp 0';
      return 'Rp ' + Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }
  </script>
</body>
</html>
