<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - Procurement System</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-inner">
      <a href="index.html" class="navbar-brand">üìã Procurement System</a>
      <ul class="navbar-nav">
        <li><a href="index.html">Dashboard</a></li>
        <li><a href="create.html">Buat Project</a></li>
        <li><a href="settings.html" class="active">‚öôÔ∏è Settings</a></li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container container-sm">

    <!-- Breadcrumb -->
    <div class="breadcrumb">
      <a href="index.html">Dashboard</a> / Settings
    </div>

    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">‚öôÔ∏è Settings</h1>
        <p class="page-subtitle">Konfigurasi koneksi ke Google Apps Script API</p>
      </div>
    </div>

    <!-- Settings Card -->
    <div class="card">
      <h2 class="card-title">API Configuration</h2>

      <!-- Status -->
      <div id="statusAlert" class="alert" style="display: none;"></div>

      <!-- Connection Status -->
      <div class="form-group">
        <label class="form-label">Status Koneksi</label>
        <div id="connectionStatus" class="connection-status">
          <span class="status-indicator status-unknown"></span>
          <span class="status-text">Belum ditest</span>
        </div>
      </div>

      <!-- Form -->
      <form id="settingsForm">

        <div class="form-group">
          <label class="form-label" for="apiUrl">
            Google Apps Script Web App URL <span class="required">*</span>
          </label>
          <input
            type="url"
            id="apiUrl"
            name="apiUrl"
            class="form-control"
            placeholder="https://script.google.com/macros/s/XXXXXXXX/exec"
          >
          <p class="form-hint">
            URL deployment dari Google Apps Script. 
            <br>Format: <code>https://script.google.com/macros/s/.../exec</code>
          </p>
          <p class="form-error" id="apiUrlError"></p>
        </div>

        <div class="form-group">
          <button type="button" id="testBtn" class="btn btn-secondary btn-block">
            üîç Test Koneksi
          </button>
        </div>

        <div class="form-group">
          <button type="submit" id="saveBtn" class="btn btn-primary btn-block">
            üíæ Simpan Settings
          </button>
        </div>

        <div class="form-group">
          <button type="button" id="resetBtn" class="btn btn-danger-outline btn-block">
            üóëÔ∏è Reset ke Default
          </button>
        </div>

      </form>
    </div>

    <!-- Help Card -->
    <div class="card">
      <h2 class="card-title">üìñ Cara Mendapatkan URL API</h2>
      <div class="help-content">
        <ol class="help-steps">
          <li>Buka project Google Apps Script</li>
          <li>Klik <strong>Deploy</strong> ‚Üí <strong>New deployment</strong></li>
          <li>Pilih type: <strong>Web app</strong></li>
          <li>Execute as: <strong>Me</strong></li>
          <li>Who has access: <strong>Anyone</strong></li>
          <li>Klik <strong>Deploy</strong></li>
          <li>Copy URL yang muncul</li>
          <li>Paste URL di kolom di atas</li>
        </ol>
      </div>
    </div>

  </div>

  <!-- Additional Styles -->
  <style>
    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .status-unknown {
      background: #9e9e9e;
    }
    
    .status-success {
      background: #4caf50;
    }
    
    .status-error {
      background: #f44336;
    }
    
    .status-loading {
      background: #ff9800;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .status-text {
      font-size: 14px;
      color: #333;
    }
    
    code {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .help-steps {
      margin: 0;
      padding-left: 20px;
    }
    
    .help-steps li {
      margin-bottom: 8px;
      line-height: 1.6;
    }
    
    .btn-danger-outline {
      background: #fff;
      color: #f44336;
      border: 1px solid #f44336;
    }
    
    .btn-danger-outline:hover:not(:disabled) {
      background: #ffebee;
    }
  </style>

  <!-- Scripts -->
  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/utils.js"></script>
  <script>
    (function() {
      
      var apiUrlInput;
      var testBtn;
      var saveBtn;
      var resetBtn;
      
      function init() {
        apiUrlInput = document.getElementById('apiUrl');
        testBtn = document.getElementById('testBtn');
        saveBtn = document.getElementById('saveBtn');
        resetBtn = document.getElementById('resetBtn');
        
        // Load current URL
        loadCurrentUrl();
        
        // Event listeners
        document.getElementById('settingsForm').addEventListener('submit', handleSave);
        testBtn.addEventListener('click', handleTest);
        resetBtn.addEventListener('click', handleReset);
      }
      
      function loadCurrentUrl() {
        var currentUrl = CONFIG.API_URL;
        if (apiUrlInput) {
          apiUrlInput.value = currentUrl;
        }
        
        // Update status
        if (CONFIG.isConfigured()) {
          setStatus('unknown', 'API URL sudah dikonfigurasi. Klik "Test Koneksi" untuk memeriksa.');
        } else {
          setStatus('unknown', 'Belum dikonfigurasi. Masukkan URL API Anda.');
        }
      }
      
      function handleSave(e) {
        e.preventDefault();
        hideAlert();
        
        var url = apiUrlInput.value.trim();
        
        // Validate
        if (!url) {
          showAlert('error', 'URL API wajib diisi');
          return;
        }
        
        if (!isValidUrl(url)) {
          showAlert('error', 'Format URL tidak valid. Harus diawali dengan https://');
          return;
        }
        
        // Save
        if (CONFIG.setApiUrl(url)) {
          showAlert('success', 'Settings berhasil disimpan!');
          setStatus('unknown', 'Tersimpan. Klik "Test Koneksi" untuk memeriksa.');
        } else {
          showAlert('error', 'Gagal menyimpan settings');
        }
      }
      
      function handleTest() {
        var url = apiUrlInput.value.trim();
        
        if (!url) {
          showAlert('error', 'Masukkan URL API terlebih dahulu');
          return;
        }
        
        if (!isValidUrl(url)) {
          showAlert('error', 'Format URL tidak valid');
          return;
        }
        
        // Temporarily save for testing
        CONFIG.setApiUrl(url);
        
        setStatus('loading', 'Menguji koneksi...');
        testBtn.disabled = true;
        testBtn.textContent = 'Testing...';
        
        // Test with simple GET request
        API.get('getProjects')
          .then(function(result) {
            testBtn.disabled = false;
            testBtn.textContent = 'üîç Test Koneksi';
            
            if (result.success) {
              setStatus('success', 'Koneksi berhasil! API berjalan dengan baik.');
              showAlert('success', 'Test berhasil! API dapat diakses.');
            } else if (result.error && result.error.indexOf('Network error') !== -1) {
              setStatus('error', 'Gagal terhubung. Periksa URL dan deployment settings.');
              showAlert('error', 'Gagal terhubung: ' + result.error);
            } else {
              // API responded but with error - still means connection works
              setStatus('success', 'Koneksi berhasil! (API merespons)');
              showAlert('warning', 'Koneksi OK, tapi API merespons dengan: ' + (result.error || 'Unknown'));
            }
          });
      }
      
      function handleReset() {
        if (confirm('Apakah Anda yakin ingin mereset settings ke default?')) {
          CONFIG.clearApiUrl();
          loadCurrentUrl();
          showAlert('success', 'Settings telah direset ke default');
          setStatus('unknown', 'Belum dikonfigurasi. Masukkan URL API Anda.');
        }
      }
      
      function isValidUrl(url) {
        return url.indexOf('https://') === 0;
      }
      
      function setStatus(type, message) {
        var statusEl = document.getElementById('connectionStatus');
        if (!statusEl) return;
        
        var indicatorClass = 'status-' + type;
        
        statusEl.innerHTML = 
          '<span class="status-indicator ' + indicatorClass + '"></span>' +
          '<span class="status-text">' + Utils.escapeHtml(message) + '</span>';
      }
      
      function showAlert(type, message) {
        var alertEl = document.getElementById('statusAlert');
        if (!alertEl) return;
        
        alertEl.className = 'alert alert-' + type;
        alertEl.textContent = message;
        alertEl.style.display = 'block';
      }
      
      function hideAlert() {
        var alertEl = document.getElementById('statusAlert');
        if (alertEl) {
          alertEl.style.display = 'none';
        }
      }
      
      // Initialize
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
      
    })();
  </script>

</body>
</html>
